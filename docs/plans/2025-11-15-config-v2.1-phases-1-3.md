# Config v2.1 Implementation Plan: Phases 1-3

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Implement Phases 1-3 of config v2.1 migration (setup, model config creation, DTO creation)

**Architecture:** Clean-break migration from flat config structure to hierarchical v2.1 structure. Archive old configs, create fresh model config from reference template, build Pydantic DTOs with strict validation.

**Tech Stack:** Pydantic, YAML, Python 3.10+

**Reference Documents:**
- Master Plan: `docs/bugs/BUNDLE-01-curriculum-observation-architecture/implementation-plan.md`
- Reference Config: `docs/bugs/BUNDLE-01-curriculum-observation-architecture/reference-config-v2.1-complete.yaml`
- Design Spec: `docs/bugs/BUNDLE-01-curriculum-observation-architecture/target-config-design-v2.md`

---

## Phase 1: Setup & Safety Net

### Task 1.1: Create Feature Branch

**Files:**
- None (git operation only)

**Step 1: Create feature branch**

```bash
git checkout -b feature/config-v2.1
```

Expected: Switched to a new branch 'feature/config-v2.1'

**Step 2: Verify branch**

```bash
git branch --show-current
```

Expected: `feature/config-v2.1`

---

### Task 1.2: Archive Old Configs

**Files:**
- Move: `configs/` → `configs_archive/`

**Step 1: Create archive directory**

```bash
mkdir configs_archive
```

**Step 2: Move all old configs**

```bash
git mv configs/* configs_archive/
```

**Step 3: Verify configs archived**

```bash
ls configs_archive/
```

Expected: L0_0_minimal, L0_5_dual_resource, L1_full_observability, L2_partial_observability, L3_temporal_mechanics, global_actions.yaml, templates

**Step 4: Commit archive**

```bash
git add -A
git commit -m "archive: move old flat configs to archive

Pre-v2.1 migration: archive existing flat config structure
All configs preserved in configs_archive/ for reference"
```

---

### Task 1.3: Capture Baseline Test Results

**Files:**
- Create: `docs/bugs/BUNDLE-01-curriculum-observation-architecture/baseline-test-results.txt`

**Step 1: Run full test suite**

```bash
UV_CACHE_DIR=.uv-cache uv run pytest tests/test_townlet/ -q --tb=no | tee docs/bugs/BUNDLE-01-curriculum-observation-architecture/baseline-test-results.txt
```

**Step 2: Verify baseline captured**

```bash
grep "passed" docs/bugs/BUNDLE-01-curriculum-observation-architecture/baseline-test-results.txt
```

Expected: Should show test count (likely 144 passed or similar)

**Step 3: Commit baseline**

```bash
git add docs/bugs/BUNDLE-01-curriculum-observation-architecture/baseline-test-results.txt
git commit -m "docs: capture baseline test results before v2.1 migration"
```

---

### Task 1.4: Create Implementation Checklist

**Files:**
- Create: `docs/bugs/BUNDLE-01-curriculum-observation-architecture/implementation-checklist.md`

**Step 1: Create checklist file**

```bash
cat > docs/bugs/BUNDLE-01-curriculum-observation-architecture/implementation-checklist.md << 'EOF'
# Config v2.1 Implementation Checklist

**Branch**: feature/config-v2.1
**Status**: In Progress
**Target**: All tests passing with v2.1 hierarchical configs

## Phase 1: Setup & Safety Net
- [x] Create feature branch
- [x] Archive old configs
- [x] Capture baseline test results
- [x] Create implementation checklist

## Phase 2: Create Model Config from Template
- [ ] Create directory structure
- [ ] Extract experiment.yaml from reference
- [ ] Extract stratum.yaml from reference
- [ ] Extract environment.yaml from reference
- [ ] Extract actions.yaml from reference
- [ ] Extract agent.yaml from reference
- [ ] Extract curriculum.yaml from reference
- [ ] Extract bars.yaml from reference
- [ ] Extract affordances.yaml from reference
- [ ] Extract training.yaml from reference

## Phase 3: DTO Creation
- [ ] Create experiment_config.py
- [ ] Create stratum_config.py
- [ ] Create environment_config.py
- [ ] Create actions_config.py
- [ ] Create agent_config.py
- [ ] Create curriculum_config.py
- [ ] Test DTOs load successfully

## Phase 4: Compiler Updates
- [ ] Update compiler main entry point
- [ ] Implement Stage 1: Load hierarchical structure
- [ ] Implement Stage 2: Cross-curriculum validation
- [ ] Update Stage 5: Observation spec with support/active pattern
- [ ] Delete old config loading code

## Phase 5: Test Updates
- [ ] Update compiler tests
- [ ] Update config DTO tests
- [ ] Update integration tests
- [ ] All L1 tests passing

## Phase 6: Remaining Levels
- [ ] Convert L0_0_minimal
- [ ] Convert L0_5_dual_resource
- [ ] Convert L2_partial_observability
- [ ] Convert L3_temporal_mechanics
- [ ] All 144 tests passing

## Phase 7: Cleanup & Validation
- [ ] Remove archived configs
- [ ] Update BUNDLE-01 documentation
- [ ] Final test run
- [ ] Merge to main
EOF
```

**Step 2: Commit checklist**

```bash
git add docs/bugs/BUNDLE-01-curriculum-observation-architecture/implementation-checklist.md
git commit -m "docs: create implementation checklist for v2.1 migration"
```

---

## Phase 2: Create Model Config from Template

### Task 2.1: Create Directory Structure

**Files:**
- Create: `configs/default_curriculum/` (directory)
- Create: `configs/default_curriculum/levels/L1_full_observability/` (directory)

**Step 1: Create experiment directory**

```bash
mkdir -p configs/default_curriculum
```

**Step 2: Create L1 level directory**

```bash
mkdir -p configs/default_curriculum/levels/L1_full_observability
```

**Step 3: Verify structure**

```bash
tree configs/
```

Expected:
```
configs/
└── default_curriculum/
    └── levels/
        └── L1_full_observability/
```

---

### Task 2.2: Extract experiment.yaml

**Files:**
- Create: `configs/default_curriculum/experiment.yaml`

**Step 1: Create experiment.yaml**

Extract lines 36-49 from reference-config-v2.1-complete.yaml (Section 1), remove comments:

```bash
cat > configs/default_curriculum/experiment.yaml << 'EOF'
version: "1.0"

metadata:
  name: "Default Curriculum"
  description: "Standard HAMLET curriculum with 5 progressive levels"
  author: "HAMLET Team"
  created: "2025-11-15"
  tags: ["default", "curriculum", "transfer-learning"]

curriculum_levels:
  - L0_0_minimal
  - L0_5_dual_resource
  - L1_full_observability
  - L2_partial_observability
  - L3_temporal_mechanics
EOF
```

**Step 2: Verify YAML syntax**

```bash
python3 -c "import yaml; yaml.safe_load(open('configs/default_curriculum/experiment.yaml'))"
```

Expected: No output (successful parse)

---

### Task 2.3: Extract stratum.yaml

**Files:**
- Create: `configs/default_curriculum/stratum.yaml`

**Step 1: Create stratum.yaml**

Extract lines 56-133 from reference (Section 2), remove comments:

```bash
cat > configs/default_curriculum/stratum.yaml << 'EOF'
version: "1.0"

substrate:
  type: grid

  grid:
    topology: square
    width: 8
    height: 8
    boundary: clamp
    distance_metric: manhattan
    observation_encoding: relative

vision_support: both
temporal_support: enabled
EOF
```

**Step 2: Verify YAML syntax**

```bash
python3 -c "import yaml; yaml.safe_load(open('configs/default_curriculum/stratum.yaml'))"
```

Expected: No output (successful parse)

---

### Task 2.4: Extract environment.yaml (Meters & Cascades)

**Files:**
- Create: `configs/default_curriculum/environment.yaml`

**Step 1: Create environment.yaml with meters and cascades**

Extract lines 140-230 from reference (Section 3), simplified:

```bash
cat > configs/default_curriculum/environment.yaml << 'EOF'
version: "1.0"

meters:
  - name: energy
    description: "Physical energy for movement and actions"
    range_type: normalized

  - name: health
    description: "Physical health, death at 0"
    range_type: normalized

  - name: satiation
    description: "Hunger level, affects health cascade"
    range_type: normalized

  - name: hygiene
    description: "Cleanliness, affects mood and social"
    range_type: normalized

  - name: money
    description: "Economic resource for purchasing"
    range_type: unbounded

  - name: fitness
    description: "Physical conditioning from exercise"
    range_type: normalized

  - name: mood
    description: "Mental state, affects energy cascade"
    range_type: normalized

  - name: social
    description: "Social connection level"
    range_type: normalized

cascade_graph:
  - source: satiation
    target: health
    description: "Low hunger damages health over time"

  - source: satiation
    target: energy
    description: "Low hunger drains energy"

  - source: mood
    target: energy
    description: "Low mood reduces energy recovery"

  - source: hygiene
    target: mood
    description: "Poor hygiene damages mood"

  - source: hygiene
    target: social
    description: "Poor hygiene damages social connection"

modulation_graph:
  - bar: energy
    affordances: [WORK]
    description: "Low energy reduces work effectiveness"

  - bar: mood
    affordances: [SOCIALIZE, WORK]
    description: "Low mood reduces social and work quality"
EOF
```

**Step 2: Verify YAML syntax**

```bash
python3 -c "import yaml; yaml.safe_load(open('configs/default_curriculum/environment.yaml'))"
```

---

### Task 2.5: Add Affordances to environment.yaml

**Files:**
- Modify: `configs/default_curriculum/environment.yaml`

**Step 1: Append affordances section**

```bash
cat >> configs/default_curriculum/environment.yaml << 'EOF'

affordances:
  - name: EAT
    description: "Consume food to restore satiation"
    category: sustenance

  - name: SLEEP
    description: "Rest to restore energy"
    category: sustenance

  - name: SHOWER
    description: "Clean to restore hygiene"
    category: hygiene

  - name: EXERCISE
    description: "Physical activity for fitness"
    category: fitness

  - name: WORK
    description: "Employment for money income"
    category: economic

  - name: SOCIALIZE
    description: "Social interaction"
    category: social

  - name: MEDITATE
    description: "Mental restoration for mood"
    category: mental

  - name: DRINK_WATER
    description: "Hydration"
    category: sustenance

  - name: BRUSH_TEETH
    description: "Dental hygiene"
    category: hygiene

  - name: LAUNDRY
    description: "Clothing hygiene"
    category: hygiene

  - name: COOK
    description: "Food preparation"
    category: sustenance

  - name: CLEAN_HOUSE
    description: "Environmental hygiene"
    category: hygiene

  - name: ENTERTAINMENT
    description: "Leisure for mood"
    category: mental

  - name: DOCTOR
    description: "Medical care for health"
    category: health
EOF
```

**Step 2: Verify YAML syntax**

```bash
python3 -c "import yaml; yaml.safe_load(open('configs/default_curriculum/environment.yaml'))"
```

---

### Task 2.6: Add VFS Variables to environment.yaml

**Files:**
- Modify: `configs/default_curriculum/environment.yaml`

**Step 1: Append VFS variables section**

```bash
cat >> configs/default_curriculum/environment.yaml << 'EOF'

variables:
  - name: deficit_energy
    type: scalar
    dims: 1
    scope: agent
    description: "How far below target energy"
    normalization:
      method: clip
      range: [0.0, 1.0]

  - name: deficit_satiation
    type: scalar
    dims: 1
    scope: agent
    description: "How far below target satiation"
    normalization:
      method: clip
      range: [0.0, 1.0]

  - name: time_since_last_eat
    type: scalar
    dims: 1
    scope: agent
    description: "Timesteps since last EAT action"
    normalization:
      method: normalize
      range: [0.0, 100.0]

  - name: time_since_last_sleep
    type: scalar
    dims: 1
    scope: agent
    description: "Timesteps since last SLEEP action"
    normalization:
      method: normalize
      range: [0.0, 100.0]
EOF
```

**Step 2: Verify complete environment.yaml**

```bash
python3 -c "import yaml; d=yaml.safe_load(open('configs/default_curriculum/environment.yaml')); print(f'Meters: {len(d[\"meters\"])}, Affordances: {len(d[\"affordances\"])}, Variables: {len(d[\"variables\"])}')"
```

Expected: `Meters: 8, Affordances: 14, Variables: 4`

---

### Task 2.7: Extract actions.yaml

**Files:**
- Create: `configs/default_curriculum/actions.yaml`

**Step 1: Create actions.yaml**

```bash
cat > configs/default_curriculum/actions.yaml << 'EOF'
version: "1.0"

substrate_actions:
  inherit: true

custom_actions:
  - name: INTERACT
    description: "Interact with affordance at current position"
    enabled_by_default: true

  - name: WAIT
    description: "Do nothing (pass turn)"
    enabled_by_default: true

  - name: REST
    description: "Passive energy recovery"
    enabled_by_default: false

  - name: MEDITATE
    description: "Passive mood boost"
    enabled_by_default: false

labels:
  preset: gaming
EOF
```

**Step 2: Verify YAML syntax**

```bash
python3 -c "import yaml; yaml.safe_load(open('configs/default_curriculum/actions.yaml'))"
```

---

### Task 2.8: Extract agent.yaml (Drive & Brain)

**Files:**
- Create: `configs/default_curriculum/agent.yaml`

**Step 1: Create agent.yaml**

Note: Simplified drive structure for now (will expand later):

```bash
cat > configs/default_curriculum/agent.yaml << 'EOF'
version: "1.0"

drive:
  version: "1.0"
  modifiers: {}
  extrinsic:
    type: multiplicative
    base: 1.0
    bars: [energy]
  intrinsic:
    strategy: rnd
    base_weight: 0.1
    apply_modifiers: []
  shaping: []
  composition:
    normalize: false
    clip: null
    log_components: true
    log_modifiers: true

brain:
  architecture: feedforward
  feedforward:
    hidden_sizes: [256, 128]
    activation: relu
  optimizer:
    type: adam
    learning_rate: 0.0001
  q_learning:
    algorithm: double_dqn
    gamma: 0.99
    target_update_frequency: 1000
EOF
```

**Step 2: Verify YAML syntax**

```bash
python3 -c "import yaml; yaml.safe_load(open('configs/default_curriculum/agent.yaml'))"
```

---

### Task 2.9: Extract L1 curriculum.yaml

**Files:**
- Create: `configs/default_curriculum/levels/L1_full_observability/curriculum.yaml`

**Step 1: Create curriculum.yaml for L1**

```bash
cat > configs/default_curriculum/levels/L1_full_observability/curriculum.yaml << 'EOF'
version: "1.0"

active_vision: global
active_temporal: false

vision_range: 0.5
day_length: null
EOF
```

**Step 2: Verify YAML syntax**

```bash
python3 -c "import yaml; yaml.safe_load(open('configs/default_curriculum/levels/L1_full_observability/curriculum.yaml'))"
```

---

### Task 2.10: Extract L1 bars.yaml (Meter Parameters)

**Files:**
- Create: `configs/default_curriculum/levels/L1_full_observability/bars.yaml`

**Step 1: Create bars.yaml**

Simplified meter params:

```bash
cat > configs/default_curriculum/levels/L1_full_observability/bars.yaml << 'EOF'
version: "1.0"

meters:
  - name: energy
    initial: 1.0
    depletion:
      passive: 0.01
      move: 0.02
      interact: 0.05
    recovery:
      natural: 0.0
    bounds:
      min: 0.0
      max: 1.0
      lethal_min: true
      lethal_max: false

  - name: health
    initial: 1.0
    depletion:
      passive: 0.005
      move: 0.0
      interact: 0.0
    recovery:
      natural: 0.001
    bounds:
      min: 0.0
      max: 1.0
      lethal_min: true
      lethal_max: false

  - name: satiation
    initial: 1.0
    depletion:
      passive: 0.008
      move: 0.01
      interact: 0.0
    recovery:
      natural: 0.0
    bounds:
      min: 0.0
      max: 1.0
      lethal_min: false
      lethal_max: false

  - name: hygiene
    initial: 1.0
    depletion:
      passive: 0.005
      move: 0.001
      interact: 0.0
    recovery:
      natural: 0.0
    bounds:
      min: 0.0
      max: 1.0
      lethal_min: false
      lethal_max: false

  - name: money
    initial: 0.0
    depletion:
      passive: 0.0
      move: 0.0
      interact: 0.0
    recovery:
      natural: 0.0
    bounds:
      min: 0.0
      max: null
      lethal_min: false
      lethal_max: false

  - name: fitness
    initial: 0.5
    depletion:
      passive: 0.002
      move: 0.0
      interact: 0.0
    recovery:
      natural: 0.0
    bounds:
      min: 0.0
      max: 1.0
      lethal_min: false
      lethal_max: false

  - name: mood
    initial: 1.0
    depletion:
      passive: 0.003
      move: 0.0
      interact: 0.0
    recovery:
      natural: 0.0
    bounds:
      min: 0.0
      max: 1.0
      lethal_min: false
      lethal_max: false

  - name: social
    initial: 1.0
    depletion:
      passive: 0.004
      move: 0.0
      interact: 0.0
    recovery:
      natural: 0.0
    bounds:
      min: 0.0
      max: 1.0
      lethal_min: false
      lethal_max: false
EOF
```

**Step 2: Add cascades section**

```bash
cat >> configs/default_curriculum/levels/L1_full_observability/bars.yaml << 'EOF'

cascades:
  - source: satiation
    target: health
    threshold: 0.3
    strength: 0.004

  - source: satiation
    target: energy
    threshold: 0.3
    strength: 0.006

  - source: mood
    target: energy
    threshold: 0.2
    strength: 0.001

  - source: hygiene
    target: mood
    threshold: 0.4
    strength: 0.003

  - source: hygiene
    target: social
    threshold: 0.4
    strength: 0.002
EOF
```

**Step 3: Verify YAML syntax**

```bash
python3 -c "import yaml; yaml.safe_load(open('configs/default_curriculum/levels/L1_full_observability/bars.yaml'))"
```

---

### Task 2.11: Extract L1 affordances.yaml

**Files:**
- Create: `configs/default_curriculum/levels/L1_full_observability/affordances.yaml`

**Step 1: Create affordances.yaml**

Simplified affordance params:

```bash
cat > configs/default_curriculum/levels/L1_full_observability/affordances.yaml << 'EOF'
version: "1.0"

affordances:
  - name: EAT
    costs:
      energy: 0.05
      money: 5.0
    effects:
      satiation: 0.4
      mood: 0.05
    opening_hours:
      enabled: false
    deployment:
      type: fixed
      positions: [[2, 2], [5, 5]]

  - name: SLEEP
    costs:
      energy: 0.0
    effects:
      energy: 0.8
      mood: 0.1
    opening_hours:
      enabled: false
    deployment:
      type: fixed
      positions: [[0, 0], [7, 7]]

  - name: SHOWER
    costs:
      energy: 0.1
      money: 1.0
    effects:
      hygiene: 0.5
      mood: 0.05
    opening_hours:
      enabled: false
    deployment:
      type: fixed
      positions: [[1, 1]]

  - name: EXERCISE
    costs:
      energy: 0.3
      satiation: 0.1
    effects:
      fitness: 0.2
      mood: 0.1
    opening_hours:
      enabled: false
    deployment:
      type: fixed
      positions: [[6, 6]]

  - name: WORK
    costs:
      energy: 0.3
      mood: 0.1
    effects:
      money: 22.5
    opening_hours:
      enabled: true
      schedule:
        - start: 9
          end: 17
    deployment:
      type: fixed
      positions: [[4, 4]]

  - name: SOCIALIZE
    costs:
      energy: 0.1
    effects:
      social: 0.3
      mood: 0.2
    opening_hours:
      enabled: false
    deployment:
      type: fixed
      positions: [[3, 3]]

  - name: MEDITATE
    costs:
      energy: 0.05
    effects:
      mood: 0.3
    opening_hours:
      enabled: false
    deployment:
      type: fixed
      positions: [[1, 7]]

  - name: DRINK_WATER
    costs: {}
    effects:
      satiation: 0.1
    opening_hours:
      enabled: false
    deployment:
      type: fixed
      positions: [[2, 2]]

  - name: BRUSH_TEETH
    costs:
      energy: 0.02
    effects:
      hygiene: 0.2
    opening_hours:
      enabled: false
    deployment:
      type: fixed
      positions: [[1, 1]]

  - name: LAUNDRY
    costs:
      energy: 0.15
      money: 2.0
    effects:
      hygiene: 0.3
    opening_hours:
      enabled: false
    deployment:
      type: fixed
      positions: [[0, 6]]

  - name: COOK
    costs:
      energy: 0.2
      money: 3.0
    effects:
      satiation: 0.6
    opening_hours:
      enabled: false
    deployment:
      type: fixed
      positions: [[2, 2]]

  - name: CLEAN_HOUSE
    costs:
      energy: 0.25
    effects:
      hygiene: 0.4
      mood: 0.1
    opening_hours:
      enabled: false
    deployment:
      type: fixed
      positions: [[4, 0]]

  - name: ENTERTAINMENT
    costs:
      money: 10.0
    effects:
      mood: 0.4
      social: 0.1
    opening_hours:
      enabled: false
    deployment:
      type: fixed
      positions: [[7, 3]]

  - name: DOCTOR
    costs:
      money: 15.0
      energy: 0.2
    effects:
      health: 0.5
    opening_hours:
      enabled: true
      schedule:
        - start: 8
          end: 18
    deployment:
      type: fixed
      positions: [[6, 2]]
EOF
```

**Step 2: Add modulations section**

```bash
cat >> configs/default_curriculum/levels/L1_full_observability/affordances.yaml << 'EOF'

modulations:
  - bar: energy
    affordances: [WORK]
    type: linear_multiplier
    threshold: 0.3
    min_multiplier: 0.5

  - bar: mood
    affordances: [SOCIALIZE, WORK]
    type: linear_multiplier
    threshold: 0.4
    min_multiplier: 0.7
EOF
```

**Step 3: Verify YAML syntax**

```bash
python3 -c "import yaml; yaml.safe_load(open('configs/default_curriculum/levels/L1_full_observability/affordances.yaml'))"
```

---

### Task 2.12: Extract L1 training.yaml

**Files:**
- Create: `configs/default_curriculum/levels/L1_full_observability/training.yaml`

**Step 1: Create training.yaml**

```bash
cat > configs/default_curriculum/levels/L1_full_observability/training.yaml << 'EOF'
version: "1.0"

population:
  size: 512

q_learning:
  use_double_dqn: true
  gamma: 0.99
  learning_rate: 0.0001
  target_update_frequency: 1000

replay_buffer:
  capacity: 100000
  batch_size: 256
  min_size: 1000

exploration:
  epsilon_start: 1.0
  epsilon_end: 0.01
  epsilon_decay: 0.995

intrinsic:
  rnd:
    feature_dim: 128
    learning_rate: 0.0001
  annealing:
    threshold: 100.0
    decay_rate: 0.995
    min_weight: 0.01

training_loop:
  max_episodes: 100000
  max_steps_per_episode: 1000
  evaluation:
    interval: 1000
    num_episodes: 10
  checkpointing:
    interval: 5000
    keep_last: 5

curriculum:
  strategy: static
EOF
```

**Step 2: Verify YAML syntax**

```bash
python3 -c "import yaml; yaml.safe_load(open('configs/default_curriculum/levels/L1_full_observability/training.yaml'))"
```

---

### Task 2.13: Commit Model Config

**Files:**
- All files created in Phase 2

**Step 1: Verify all files exist**

```bash
find configs/default_curriculum -name "*.yaml" | sort
```

Expected: 9 YAML files

**Step 2: Commit all config files**

```bash
git add configs/
git commit -m "feat(config): create L1 model config from v2.1 reference template

Created complete v2.1 hierarchical config structure for L1_full_observability:
- Experiment-level: experiment, stratum, environment, actions, agent (5 files)
- Curriculum-level: curriculum, bars, affordances, training (4 files)

Structure extracted from reference-config-v2.1-complete.yaml
Ready for DTO creation in Phase 3"
```

---

## Phase 3: DTO Creation

### Task 3.1: Create experiment_config.py

**Files:**
- Create: `src/townlet/config/experiment_config.py`

**Step 1: Create DTO file**

```bash
cat > src/townlet/config/experiment_config.py << 'EOF'
"""Experiment-level configuration DTOs for v2.1."""

from pydantic import BaseModel, Field
from typing import List


class ExperimentMetadata(BaseModel):
    """Experiment metadata."""

    name: str
    description: str
    author: str
    created: str
    tags: List[str] = Field(default_factory=list)

    class Config:
        extra = "forbid"


class ExperimentConfig(BaseModel):
    """Experiment configuration (experiment.yaml)."""

    version: str
    metadata: ExperimentMetadata
    curriculum_levels: List[str]

    class Config:
        extra = "forbid"

    @classmethod
    def from_yaml(cls, path):
        """Load from YAML file."""
        import yaml
        from pathlib import Path

        with open(Path(path)) as f:
            data = yaml.safe_load(f)
        return cls(**data)
EOF
```

**Step 2: Test DTO loads successfully**

```bash
python3 << 'PYTEST'
from src.townlet.config.experiment_config import ExperimentConfig

config = ExperimentConfig.from_yaml("configs/default_curriculum/experiment.yaml")
print(f"✓ Loaded experiment: {config.metadata.name}")
print(f"✓ Curriculum levels: {len(config.curriculum_levels)}")
assert config.version == "1.0"
assert len(config.curriculum_levels) == 5
print("SUCCESS: ExperimentConfig working")
PYTEST
```

Expected: "SUCCESS: ExperimentConfig working"

**Step 3: Commit DTO**

```bash
git add src/townlet/config/experiment_config.py
git commit -m "feat(config): add ExperimentConfig DTO with YAML loader"
```

---

### Task 3.2: Create stratum_config.py

**Files:**
- Create: `src/townlet/config/stratum_config.py`

**Step 1: Create DTO file**

```bash
cat > src/townlet/config/stratum_config.py << 'EOF'
"""Stratum-level configuration DTOs for v2.1."""

from pydantic import BaseModel
from typing import Literal


class GridConfig(BaseModel):
    """Grid substrate configuration."""

    topology: Literal["square", "hexagonal"]
    width: int
    height: int
    boundary: Literal["clamp", "wrap", "bounce", "sticky"]
    distance_metric: Literal["manhattan", "euclidean", "chebyshev"]
    observation_encoding: Literal["relative", "scaled", "absolute"]

    class Config:
        extra = "forbid"


class SubstrateConfig(BaseModel):
    """Substrate configuration."""

    type: Literal["grid", "grid3d", "gridnd", "continuous", "continuousnd", "aspatial"]
    grid: GridConfig

    class Config:
        extra = "forbid"


class StratumConfig(BaseModel):
    """Stratum configuration (stratum.yaml)."""

    version: str
    substrate: SubstrateConfig
    vision_support: Literal["global", "partial", "both", "none"]
    temporal_support: Literal["enabled", "disabled"]

    class Config:
        extra = "forbid"

    @classmethod
    def from_yaml(cls, path):
        """Load from YAML file."""
        import yaml
        from pathlib import Path

        with open(Path(path)) as f:
            data = yaml.safe_load(f)
        return cls(**data)
EOF
```

**Step 2: Test DTO loads successfully**

```bash
python3 << 'PYTEST'
from src.townlet.config.stratum_config import StratumConfig

config = StratumConfig.from_yaml("configs/default_curriculum/stratum.yaml")
print(f"✓ Substrate type: {config.substrate.type}")
print(f"✓ Grid size: {config.substrate.grid.width}×{config.substrate.grid.height}")
print(f"✓ Vision support: {config.vision_support}")
assert config.substrate.grid.width == 8
assert config.vision_support == "both"
print("SUCCESS: StratumConfig working")
PYTEST
```

Expected: "SUCCESS: StratumConfig working"

**Step 3: Commit DTO**

```bash
git add src/townlet/config/stratum_config.py
git commit -m "feat(config): add StratumConfig DTO with grid/substrate support"
```

---

### Task 3.3: Create environment_config.py (Part 1: Base DTOs)

**Files:**
- Create: `src/townlet/config/environment_config.py`

**Step 1: Create base DTO classes**

```bash
cat > src/townlet/config/environment_config.py << 'EOF'
"""Environment-level configuration DTOs for v2.1."""

from pydantic import BaseModel
from typing import List, Literal, Optional


class MeterDefinition(BaseModel):
    """Meter vocabulary definition."""

    name: str
    description: str
    range_type: Literal["normalized", "unbounded", "integer"]

    class Config:
        extra = "forbid"


class CascadeGraphEdge(BaseModel):
    """Cascade graph structure (vocabulary only)."""

    source: str
    target: str
    description: str

    class Config:
        extra = "forbid"


class ModulationGraphEdge(BaseModel):
    """Modulation graph structure."""

    bar: str
    affordances: List[str]
    description: str

    class Config:
        extra = "forbid"


class AffordanceDefinition(BaseModel):
    """Affordance vocabulary definition."""

    name: str
    description: str
    category: str

    class Config:
        extra = "forbid"


class VFSNormalizationSpec(BaseModel):
    """VFS variable normalization specification."""

    method: Literal["clip", "normalize", "standardize", "none"]
    range: List[float]

    class Config:
        extra = "forbid"


class VFSVariableDefinition(BaseModel):
    """VFS variable definition."""

    name: str
    type: Literal["scalar", "vector"]
    dims: int
    scope: Literal["global", "agent", "agent_private"]
    description: str
    normalization: VFSNormalizationSpec

    class Config:
        extra = "forbid"
EOF
```

---

### Task 3.4: Create environment_config.py (Part 2: Main DTO)

**Files:**
- Modify: `src/townlet/config/environment_config.py`

**Step 1: Add EnvironmentConfig class**

```bash
cat >> src/townlet/config/environment_config.py << 'EOF'


class EnvironmentConfig(BaseModel):
    """Environment configuration (environment.yaml)."""

    version: str
    meters: List[MeterDefinition]
    cascade_graph: List[CascadeGraphEdge]
    modulation_graph: List[ModulationGraphEdge]
    affordances: List[AffordanceDefinition]
    variables: List[VFSVariableDefinition]
    cues: Optional[List] = None

    class Config:
        extra = "forbid"

    @classmethod
    def from_yaml(cls, path):
        """Load from YAML file."""
        import yaml
        from pathlib import Path

        with open(Path(path)) as f:
            data = yaml.safe_load(f)
        return cls(**data)
EOF
```

**Step 2: Test DTO loads successfully**

```bash
python3 << 'PYTEST'
from src.townlet.config.environment_config import EnvironmentConfig

config = EnvironmentConfig.from_yaml("configs/default_curriculum/environment.yaml")
print(f"✓ Meters: {len(config.meters)}")
print(f"✓ Affordances: {len(config.affordances)}")
print(f"✓ Variables: {len(config.variables)}")
print(f"✓ Cascades: {len(config.cascade_graph)}")
assert len(config.meters) == 8
assert len(config.affordances) == 14
assert len(config.variables) == 4
print("SUCCESS: EnvironmentConfig working")
PYTEST
```

Expected: "SUCCESS: EnvironmentConfig working"

**Step 3: Commit DTO**

```bash
git add src/townlet/config/environment_config.py
git commit -m "feat(config): add EnvironmentConfig DTO with meters/affordances/VFS"
```

---

### Task 3.5: Create actions_config.py

**Files:**
- Create: `src/townlet/config/actions_config.py`

**Step 1: Create DTO file**

```bash
cat > src/townlet/config/actions_config.py << 'EOF'
"""Actions configuration DTOs for v2.1."""

from pydantic import BaseModel
from typing import List, Literal


class CustomActionDefinition(BaseModel):
    """Custom action definition."""

    name: str
    description: str
    enabled_by_default: bool

    class Config:
        extra = "forbid"


class SubstrateActionsConfig(BaseModel):
    """Substrate actions configuration."""

    inherit: bool

    class Config:
        extra = "forbid"


class ActionsConfig(BaseModel):
    """Actions configuration (actions.yaml)."""

    version: str
    substrate_actions: SubstrateActionsConfig
    custom_actions: List[CustomActionDefinition]
    labels: Literal["gaming", "6dof", "cardinal", "math"]

    class Config:
        extra = "forbid"

    @classmethod
    def from_yaml(cls, path):
        """Load from YAML file."""
        import yaml
        from pathlib import Path

        with open(Path(path)) as f:
            data = yaml.safe_load(f)
        return cls(**data)
EOF
```

**Step 2: Test DTO loads successfully**

```bash
python3 << 'PYTEST'
from src.townlet.config.actions_config import ActionsConfig

config = ActionsConfig.from_yaml("configs/default_curriculum/actions.yaml")
print(f"✓ Custom actions: {len(config.custom_actions)}")
print(f"✓ Substrate inherit: {config.substrate_actions.inherit}")
print(f"✓ Labels: {config.labels}")
assert len(config.custom_actions) == 4
assert config.substrate_actions.inherit == True
print("SUCCESS: ActionsConfig working")
PYTEST
```

Expected: "SUCCESS: ActionsConfig working"

**Step 3: Commit DTO**

```bash
git add src/townlet/config/actions_config.py
git commit -m "feat(config): add ActionsConfig DTO with custom actions"
```

---

### Task 3.6: Create agent_config.py (Simplified)

**Files:**
- Create: `src/townlet/config/agent_config.py`

**Step 1: Create DTO file**

Note: Simplified for now, will expand drive structure later:

```bash
cat > src/townlet/config/agent_config.py << 'EOF'
"""Agent configuration DTOs for v2.1."""

from pydantic import BaseModel
from typing import List, Literal, Optional, Dict, Any


class FeedforwardConfig(BaseModel):
    """Feedforward network configuration."""

    hidden_sizes: List[int]
    activation: Literal["relu", "tanh", "elu", "gelu"]

    class Config:
        extra = "forbid"


class OptimizerConfig(BaseModel):
    """Optimizer configuration."""

    type: Literal["adam", "sgd", "rmsprop"]
    learning_rate: float

    class Config:
        extra = "forbid"


class QLearningConfig(BaseModel):
    """Q-learning algorithm configuration."""

    algorithm: Literal["dqn", "double_dqn"]
    gamma: float
    target_update_frequency: int

    class Config:
        extra = "forbid"


class BrainConfig(BaseModel):
    """Brain (network architecture) configuration."""

    architecture: Literal["feedforward", "recurrent"]
    feedforward: Optional[FeedforwardConfig] = None
    optimizer: OptimizerConfig
    q_learning: QLearningConfig

    class Config:
        extra = "forbid"


class AgentConfig(BaseModel):
    """Agent configuration (agent.yaml)."""

    version: str
    drive: Dict[str, Any]  # Simplified: raw dict for now
    brain: BrainConfig

    class Config:
        extra = "forbid"

    @classmethod
    def from_yaml(cls, path):
        """Load from YAML file."""
        import yaml
        from pathlib import Path

        with open(Path(path)) as f:
            data = yaml.safe_load(f)
        return cls(**data)
EOF
```

**Step 2: Test DTO loads successfully**

```bash
python3 << 'PYTEST'
from src.townlet.config.agent_config import AgentConfig

config = AgentConfig.from_yaml("configs/default_curriculum/agent.yaml")
print(f"✓ Brain architecture: {config.brain.architecture}")
print(f"✓ Hidden layers: {config.brain.feedforward.hidden_sizes}")
print(f"✓ Q-learning: {config.brain.q_learning.algorithm}")
assert config.brain.architecture == "feedforward"
assert config.brain.q_learning.gamma == 0.99
print("SUCCESS: AgentConfig working")
PYTEST
```

Expected: "SUCCESS: AgentConfig working"

**Step 3: Commit DTO**

```bash
git add src/townlet/config/agent_config.py
git commit -m "feat(config): add AgentConfig DTO with brain/drive"
```

---

### Task 3.7: Create curriculum_config.py

**Files:**
- Create: `src/townlet/config/curriculum_config.py`

**Step 1: Create DTO file with validators**

```bash
cat > src/townlet/config/curriculum_config.py << 'EOF'
"""Curriculum-level configuration DTOs for v2.1."""

from pydantic import BaseModel, validator
from typing import Literal, Optional


class CurriculumConfig(BaseModel):
    """Curriculum configuration (curriculum.yaml)."""

    version: str
    active_vision: Literal["global", "partial"]
    active_temporal: bool
    vision_range: float
    day_length: Optional[int]

    @validator('vision_range')
    def validate_vision_range(cls, v):
        """Validate vision_range is normalized [0.0, 1.0]."""
        if not (0.0 <= v <= 1.0):
            raise ValueError("vision_range must be in [0.0, 1.0]")
        return v

    @validator('day_length')
    def validate_day_length(cls, v, values):
        """Validate day_length requirements based on active_temporal."""
        active_temporal = values.get('active_temporal')
        if active_temporal and v is None:
            raise ValueError("day_length required when active_temporal=true")
        if not active_temporal and v is not None:
            raise ValueError("day_length must be null when active_temporal=false")
        return v

    class Config:
        extra = "forbid"

    @classmethod
    def from_yaml(cls, path):
        """Load from YAML file."""
        import yaml
        from pathlib import Path

        with open(Path(path)) as f:
            data = yaml.safe_load(f)
        return cls(**data)
EOF
```

**Step 2: Test DTO loads successfully**

```bash
python3 << 'PYTEST'
from src.townlet.config.curriculum_config import CurriculumConfig

config = CurriculumConfig.from_yaml("configs/default_curriculum/levels/L1_full_observability/curriculum.yaml")
print(f"✓ Active vision: {config.active_vision}")
print(f"✓ Active temporal: {config.active_temporal}")
print(f"✓ Vision range: {config.vision_range}")
print(f"✓ Day length: {config.day_length}")
assert config.active_vision == "global"
assert config.active_temporal == False
assert config.day_length is None
print("SUCCESS: CurriculumConfig working")
PYTEST
```

Expected: "SUCCESS: CurriculumConfig working"

**Step 3: Test validators work**

```bash
python3 << 'PYTEST'
from src.townlet.config.curriculum_config import CurriculumConfig
from pydantic import ValidationError

# Test vision_range out of bounds
try:
    CurriculumConfig(
        version="1.0",
        active_vision="global",
        active_temporal=False,
        vision_range=2.0,  # Invalid!
        day_length=None
    )
    print("ERROR: Should have failed validation")
except ValidationError as e:
    print("✓ vision_range validation working")

# Test day_length missing when active_temporal=true
try:
    CurriculumConfig(
        version="1.0",
        active_vision="global",
        active_temporal=True,  # True
        vision_range=0.5,
        day_length=None  # Invalid!
    )
    print("ERROR: Should have failed validation")
except ValidationError as e:
    print("✓ day_length validation working")

print("SUCCESS: All validators working")
PYTEST
```

Expected: "SUCCESS: All validators working"

**Step 4: Commit DTO**

```bash
git add src/townlet/config/curriculum_config.py
git commit -m "feat(config): add CurriculumConfig DTO with validation

Implements support/active pattern fields:
- active_vision (global/partial)
- active_temporal (bool)
- vision_range (normalized 0.0-1.0)
- day_length (required when active_temporal=true)

Includes Pydantic validators for cross-field validation"
```

---

### Task 3.8: Commit Phase 3 Completion

**Files:**
- All DTOs created in Phase 3

**Step 1: Verify all DTOs compile**

```bash
python3 << 'PYTEST'
from src.townlet.config.experiment_config import ExperimentConfig
from src.townlet.config.stratum_config import StratumConfig
from src.townlet.config.environment_config import EnvironmentConfig
from src.townlet.config.actions_config import ActionsConfig
from src.townlet.config.agent_config import AgentConfig
from src.townlet.config.curriculum_config import CurriculumConfig

print("✓ All 6 DTOs imported successfully")
PYTEST
```

Expected: "✓ All 6 DTOs imported successfully"

**Step 2: Update checklist**

Mark Phase 3 tasks complete in `implementation-checklist.md`:
- [x] Create experiment_config.py
- [x] Create stratum_config.py
- [x] Create environment_config.py
- [x] Create actions_config.py
- [x] Create agent_config.py
- [x] Create curriculum_config.py
- [x] Test DTOs load successfully

**Step 3: Commit checklist update**

```bash
git add docs/bugs/BUNDLE-01-curriculum-observation-architecture/implementation-checklist.md
git commit -m "docs: mark Phase 3 (DTO creation) complete in checklist"
```

---

## Completion

**Phases 1-3 Complete!**

You now have:
- ✅ Feature branch created
- ✅ Old configs archived
- ✅ Baseline test results captured
- ✅ Complete L1 v2.1 model config (9 YAML files)
- ✅ All 6 Pydantic DTOs with strict validation
- ✅ DTOs tested and loading successfully

**Next Steps:**
- Phase 4: Compiler Updates (update compiler.py to load v2.1 structure)
- Phase 5: Test Updates (fix broken tests)
- Phase 6: Remaining Levels (L0_0, L0_5, L2, L3)
- Phase 7: Cleanup & Merge

**To continue:** Request Phase 4-7 plan or begin implementation.
